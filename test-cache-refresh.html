<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache Refresh Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>ç¼“å­˜åˆ·æ–°æµ‹è¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h2>1. æµ‹è¯•æ•°æ®åŠ è½½</h2>
        <button class="button" onclick="testDataLoad()">åŠ è½½Intelligenceæ•°æ®</button>
        <button class="button" onclick="testArticleLoad()">åŠ è½½ç‰¹å®šæ–‡ç« </button>
        <div id="dataResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æµ‹è¯•ç¼“å­˜æ¸…é™¤</h2>
        <button class="button" onclick="clearBrowserCache()">æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</button>
        <button class="button" onclick="forceRefresh()">å¼ºåˆ¶åˆ·æ–°æ•°æ®</button>
        <div id="cacheResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. éªŒè¯æ–‡ç« å†…å®¹</h2>
        <button class="button" onclick="verifyArticleContent()">éªŒè¯"The Age of Great Voyages"å†…å®¹</button>
        <div id="verifyResult" class="result"></div>
    </div>

    <script>
        // æ¨¡æ‹ŸContentServiceçš„åŸºæœ¬åŠŸèƒ½
        class TestContentService {
            constructor() {
                this.cache = null;
                this.cacheTimestamp = 0;
            }
            
            clearCache() {
                console.log('ğŸ”„ TestContentService: Clearing cache');
                this.cache = null;
                this.cacheTimestamp = 0;
                console.log('âœ… TestContentService: Cache cleared');
            }
            
            async getIntelligence(forceRefresh = false) {
                console.log(`ğŸ“Š TestContentService: Getting intelligence data (forceRefresh: ${forceRefresh})`);
                
                if (!forceRefresh && this.cache && this.isCacheValid()) {
                    console.log('ğŸ’¾ TestContentService: Using cached data');
                    return this.cache;
                }
                
                try {
                    console.log('ğŸŒ TestContentService: Fetching fresh data from /data/intelligence.json');
                    const response = await fetch('/data/intelligence.json');
                    if (!response.ok) {
                        throw new Error(`Failed to fetch: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log(`âœ… TestContentService: Loaded ${data.length} items`);
                    
                    this.cache = data;
                    this.cacheTimestamp = Date.now();
                    return data;
                } catch (error) {
                    console.error('âŒ TestContentService: Error fetching data:', error);
                    throw error;
                }
            }
            
            async getIntelligenceById(id) {
                console.log(`ğŸ” TestContentService: Getting article by ID: ${id}`);
                const intelligence = await this.getIntelligence();
                const article = intelligence.find(item => item.id === id);
                
                if (article) {
                    console.log(`âœ… TestContentService: Found article "${article.title}"`);
                    console.log(`ğŸ“„ TestContentService: Content length: ${article.content?.length || 0} characters`);
                } else {
                    console.log(`âŒ TestContentService: Article with ID "${id}" not found`);
                }
                
                return article || null;
            }
            
            isCacheValid() {
                const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
                return this.cacheTimestamp && (Date.now() - this.cacheTimestamp) < CACHE_DURATION;
            }
        }
        
        const testService = new TestContentService();
        
        async function testDataLoad() {
            const resultDiv = document.getElementById('dataResult');
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨åŠ è½½æ•°æ®...';
            
            try {
                const data = await testService.getIntelligence();
                resultDiv.className = 'result success';
                resultDiv.textContent = `æˆåŠŸåŠ è½½ ${data.length} ç¯‡æ–‡ç« \n\nå‰3ç¯‡æ–‡ç« æ ‡é¢˜:\n${data.slice(0, 3).map(item => `- ${item.title}`).join('\n')}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
            }
        }
        
        async function testArticleLoad() {
            const resultDiv = document.getElementById('dataResult');
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨åŠ è½½ç‰¹å®šæ–‡ç« ...';
            
            try {
                const article = await testService.getIntelligenceById('china-ev-global-expansion-analysis');
                if (article) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `æˆåŠŸåŠ è½½æ–‡ç« :\næ ‡é¢˜: ${article.title}\næ—¥æœŸ: ${article.date}\nå†…å®¹é•¿åº¦: ${article.content?.length || 0} å­—ç¬¦\n\nå†…å®¹é¢„è§ˆ:\n${article.content?.substring(0, 200)}...`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
            }
        }
        
        function clearBrowserCache() {
            const resultDiv = document.getElementById('cacheResult');
            
            // æ¸…é™¤å„ç§ç¼“å­˜
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // æ¸…é™¤localStorageå’ŒsessionStorage
            localStorage.clear();
            sessionStorage.clear();
            
            // æ¸…é™¤æˆ‘ä»¬çš„æµ‹è¯•æœåŠ¡ç¼“å­˜
            testService.clearCache();
            
            resultDiv.className = 'result success';
            resultDiv.textContent = 'æµè§ˆå™¨ç¼“å­˜å·²æ¸…é™¤\n- Service Workerç¼“å­˜å·²æ¸…é™¤\n- localStorageå·²æ¸…é™¤\n- sessionStorageå·²æ¸…é™¤\n- åº”ç”¨ç¼“å­˜å·²æ¸…é™¤';
        }
        
        async function forceRefresh() {
            const resultDiv = document.getElementById('cacheResult');
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨å¼ºåˆ¶åˆ·æ–°æ•°æ®...';
            
            try {
                testService.clearCache();
                const data = await testService.getIntelligence(true);
                resultDiv.className = 'result success';
                resultDiv.textContent = `å¼ºåˆ¶åˆ·æ–°æˆåŠŸ\né‡æ–°åŠ è½½äº† ${data.length} ç¯‡æ–‡ç« \næ—¶é—´æˆ³: ${new Date().toLocaleString()}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `å¼ºåˆ¶åˆ·æ–°å¤±è´¥: ${error.message}`;
            }
        }
        
        async function verifyArticleContent() {
            const resultDiv = document.getElementById('verifyResult');
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨éªŒè¯æ–‡ç« å†…å®¹...';
            
            try {
                const article = await testService.getIntelligenceById('china-ev-global-expansion-analysis');
                if (article) {
                    const expectedKeywords = [
                        'Age of Great Voyages',
                        'China\'s electric vehicles',
                        'global expansion',
                        'furnace of competition',
                        'price war'
                    ];
                    
                    const foundKeywords = expectedKeywords.filter(keyword => 
                        article.content?.includes(keyword) || article.title?.includes(keyword)
                    );
                    
                    const isContentValid = foundKeywords.length >= 3;
                    
                    resultDiv.className = `result ${isContentValid ? 'success' : 'error'}`;
                    resultDiv.textContent = `æ–‡ç« éªŒè¯ç»“æœ:\næ ‡é¢˜: ${article.title}\nå†…å®¹é•¿åº¦: ${article.content?.length || 0} å­—ç¬¦\n\nå…³é”®è¯æ£€æŸ¥ (${foundKeywords.length}/${expectedKeywords.length}):\n${expectedKeywords.map(kw => `${foundKeywords.includes(kw) ? 'âœ…' : 'âŒ'} ${kw}`).join('\n')}\n\n${isContentValid ? 'âœ… æ–‡ç« å†…å®¹éªŒè¯é€šè¿‡' : 'âŒ æ–‡ç« å†…å®¹å¯èƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬'}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ï¼Œè¯·æ£€æŸ¥æ–‡ç« ID';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `éªŒè¯å¤±è´¥: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºæœ¬æµ‹è¯•
        window.addEventListener('load', () => {
            console.log('ğŸš€ Cache Refresh Test Tool loaded');
            console.log('ğŸ“‹ Available tests: Data Load, Cache Clear, Content Verify');
        });
    </script>
</body>
</html>